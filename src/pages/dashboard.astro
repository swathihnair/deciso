---
import Layout from '../layouts/Layout.astro';
import Sidebar from '../components/Sidebar.svelte';
import MainDashboard from '../components/MainDashboard.svelte';
import FinancialDashboard from '../components/FinancialDashboard.svelte';
import StyleAssistant from '../components/StyleAssistant.svelte';
import Settings from '../components/Settings.svelte';
---

<Layout title="Dashboard - Deciso">
  <div class="flex min-h-screen">
    <Sidebar client:load />
    
    <main class="flex-1 p-6">
      <div id="dashboard-content">
        <MainDashboard client:load />
      </div>
      
      <div id="financial-content" style="display: none;">
        <FinancialDashboard client:load />
      </div>
      
      <div id="style-content" style="display: none;">
        <StyleAssistant client:load />
      </div>
      
      <div id="goals-content" style="display: none;">
        <div class="space-y-6">
          <h2 class="text-2xl font-bold text-white">Goals & Planning</h2>
          
          <!-- Add New Goal Form -->
          <div class="bg-white/10 backdrop-blur-md p-6 rounded-xl border border-white/20">
            <h3 class="text-lg font-semibold text-white mb-4">Add New Goal</h3>
            <div class="grid md:grid-cols-4 gap-4">
              <input
                type="text"
                id="goalTitle"
                placeholder="Goal title"
                class="px-3 py-2 bg-white/10 border border-white/20 rounded-md text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-white/50"
              />
              
              <select
                id="goalCategory"
                class="px-3 py-2 bg-white/10 border border-white/20 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-white/50"
              >
                <option value="financial">Financial</option>
                <option value="personal">Personal</option>
                <option value="health">Health</option>
                <option value="career">Career</option>
                <option value="education">Education</option>
              </select>
              
              <input
                type="date"
                id="goalDeadline"
                class="px-3 py-2 bg-white/10 border border-white/20 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-white/50"
              />
              
              <button
                onclick="addGoal()"
                class="bg-white text-indigo-600 px-4 py-2 rounded-md font-semibold hover:bg-gray-100 transition-colors"
              >
                Add Goal
              </button>
            </div>
          </div>
          
          <!-- Goals Stats -->
          <div class="grid md:grid-cols-4 gap-6">
            <div class="bg-white/10 backdrop-blur-md p-6 rounded-xl border border-white/20">
              <h3 class="text-lg font-semibold text-white mb-2">Total Goals</h3>
              <p class="text-3xl font-bold text-blue-400" id="totalGoals">0</p>
            </div>
            
            <div class="bg-white/10 backdrop-blur-md p-6 rounded-xl border border-white/20">
              <h3 class="text-lg font-semibold text-white mb-2">Completed</h3>
              <p class="text-3xl font-bold text-green-400" id="completedGoals">0</p>
            </div>
            
            <div class="bg-white/10 backdrop-blur-md p-6 rounded-xl border border-white/20">
              <h3 class="text-lg font-semibold text-white mb-2">In Progress</h3>
              <p class="text-3xl font-bold text-yellow-400" id="inProgressGoals">0</p>
            </div>
            
            <div class="bg-white/10 backdrop-blur-md p-6 rounded-xl border border-white/20">
              <h3 class="text-lg font-semibold text-white mb-2">Completion Rate</h3>
              <p class="text-3xl font-bold text-purple-400" id="completionRate">0%</p>
            </div>
          </div>
          
          <!-- Goals List -->
          <div class="bg-white/10 backdrop-blur-md p-6 rounded-xl border border-white/20">
            <div class="flex items-center justify-between mb-6">
              <h3 class="text-lg font-semibold text-white flex items-center">
                <span class="text-2xl mr-3">üéØ</span>
                Your Goals
              </h3>
              <div class="flex gap-2">
                <button onclick="filterGoals('all')" class="px-3 py-1 bg-white/20 text-white rounded-md text-sm hover:bg-white/30 transition-colors">All</button>
                <button onclick="filterGoals('active')" class="px-3 py-1 bg-white/20 text-white rounded-md text-sm hover:bg-white/30 transition-colors">Active</button>
                <button onclick="filterGoals('completed')" class="px-3 py-1 bg-white/20 text-white rounded-md text-sm hover:bg-white/30 transition-colors">Completed</button>
              </div>
            </div>
            
            <div id="goalsList" class="space-y-3">
              <!-- Goals will be dynamically added here -->
            </div>
          </div>
        </div>
      </div>
      
      <div id="settings-content" style="display: none;">
        <Settings client:load />
      </div>
    </main>
  </div>
</Layout>

<script>
  // Handle sidebar navigation and hash routing
  document.addEventListener('DOMContentLoaded', function() {
    const sidebar = document.querySelector('aside');
    const contentSections = {
      'dashboard': document.getElementById('dashboard-content'),
      'financial': document.getElementById('financial-content'),
      'style': document.getElementById('style-content'),
      'goals': document.getElementById('goals-content'),
      'settings': document.getElementById('settings-content')
    };
    
    // Goals management system
    let goals = JSON.parse(localStorage.getItem('goals')) || [
      {
        id: 1,
        title: 'Save $5000 for emergency fund',
        category: 'financial',
        deadline: '2024-06-30',
        completed: false,
        createdAt: new Date().toISOString()
      },
      {
        id: 2,
        title: 'Complete online course certification',
        category: 'education',
        deadline: '2024-04-15',
        completed: false,
        createdAt: new Date().toISOString()
      },
      {
        id: 3,
        title: 'Exercise 3 times per week',
        category: 'health',
        deadline: '2024-12-31',
        completed: true,
        createdAt: new Date().toISOString()
      },
      {
        id: 4,
        title: 'Read 12 books this year',
        category: 'personal',
        deadline: '2024-12-31',
        completed: false,
        createdAt: new Date().toISOString()
      },
      {
        id: 5,
        title: 'Launch personal portfolio website',
        category: 'career',
        deadline: '2024-03-31',
        completed: true,
        createdAt: new Date().toISOString()
      }
    ];
    let currentFilter = 'all';
    
    function showSection(sectionId) {
      // Hide all sections
      Object.values(contentSections).forEach(section => {
        if (section) section.style.display = 'none';
      });
      
      // Show selected section
      if (contentSections[sectionId]) {
        contentSections[sectionId].style.display = 'block';
      }
    }
    
    function getSectionFromHash(hash) {
      const sectionMap = {
        '#financial': 'financial',
        '#style': 'style', 
        '#goals': 'goals',
        '#settings': 'settings',
        '#activities': 'dashboard',
        '#tasks': 'dashboard'
      };
      return sectionMap[hash] || 'dashboard';
    }
    
    // Handle hash change
    function handleHashChange() {
      const hash = window.location.hash;
      const sectionId = getSectionFromHash(hash);
      showSection(sectionId);
    }
    
    // Check hash on load
    handleHashChange();
    
    // Listen for hash changes
    window.addEventListener('hashchange', handleHashChange);
    
    // Add click listeners to sidebar buttons
    if (sidebar) {
      sidebar.addEventListener('click', function(e) {
        const target = e.target as HTMLElement;
        const button = target?.closest('button');
        if (button) {
          const sectionId = button.textContent.toLowerCase().includes('dashboard') ? 'dashboard' :
                           button.textContent.toLowerCase().includes('financial') ? 'financial' :
                           button.textContent.toLowerCase().includes('style') ? 'style' :
                           button.textContent.toLowerCase().includes('goals') ? 'goals' :
                           button.textContent.toLowerCase().includes('settings') ? 'settings' : 'dashboard';
          
          showSection(sectionId);
          // Update hash
          window.location.hash = sectionId;
        }
      });
    }
    
    // Goals functionality
    window.addGoal = function() {
      const title = document.getElementById('goalTitle').value.trim();
      const category = document.getElementById('goalCategory').value;
      const deadline = document.getElementById('goalDeadline').value;
      
      if (!title) {
        alert('Please enter a goal title');
        return;
      }
      
      const goal = {
        id: Date.now(),
        title: title,
        category: category,
        deadline: deadline,
        completed: false,
        createdAt: new Date().toISOString()
      };
      
      goals.push(goal);
      saveGoals();
      renderGoals();
      updateStats();
      
      // Clear form
      document.getElementById('goalTitle').value = '';
      document.getElementById('goalCategory').value = 'financial';
      document.getElementById('goalDeadline').value = '';
      
      alert('Goal added successfully!');
    };
    
    window.toggleGoal = function(id) {
      const goal = goals.find(g => g.id === id);
      if (goal) {
        goal.completed = !goal.completed;
        saveGoals();
        renderGoals();
        updateStats();
      }
    };
    
    window.deleteGoal = function(id) {
      if (confirm('Are you sure you want to delete this goal?')) {
        goals = goals.filter(g => g.id !== id);
        saveGoals();
        renderGoals();
        updateStats();
      }
    };
    
    window.filterGoals = function(filter) {
      currentFilter = filter;
      renderGoals();
    };
    
    function saveGoals() {
      localStorage.setItem('goals', JSON.stringify(goals));
    }
    
    function updateStats() {
      const total = goals.length;
      const completed = goals.filter(g => g.completed).length;
      const inProgress = total - completed;
      const rate = total > 0 ? Math.round((completed / total) * 100) : 0;
      
      document.getElementById('totalGoals').textContent = total;
      document.getElementById('completedGoals').textContent = completed;
      document.getElementById('inProgressGoals').textContent = inProgress;
      document.getElementById('completionRate').textContent = rate + '%';
    }
    
    function renderGoals() {
      const goalsList = document.getElementById('goalsList');
      if (!goalsList) return;
      
      let filteredGoals = goals;
      if (currentFilter === 'active') {
        filteredGoals = goals.filter(g => !g.completed);
      } else if (currentFilter === 'completed') {
        filteredGoals = goals.filter(g => g.completed);
      }
      
      if (filteredGoals.length === 0) {
        goalsList.innerHTML = '<p class="text-white/60 text-center py-8">No goals found. Add your first goal above!</p>';
        return;
      }
      
      goalsList.innerHTML = filteredGoals.map(goal => {
        const categoryColors = {
          financial: 'from-green-400 to-emerald-500',
          personal: 'from-blue-400 to-cyan-500',
          health: 'from-pink-400 to-rose-500',
          career: 'from-purple-400 to-indigo-500',
          education: 'from-yellow-400 to-orange-500'
        };
        
        const deadlineText = goal.deadline ? new Date(goal.deadline).toLocaleDateString() : 'No deadline';
        const isOverdue = goal.deadline && new Date(goal.deadline) < new Date() && !goal.completed;
        
        return `
          <div class="group p-4 bg-white/5 hover:bg-white/10 rounded-xl border border-white/10 transition-all duration-300 ${goal.completed ? 'opacity-60' : ''}">
            <div class="flex items-center justify-between">
              <div class="flex items-center flex-1">
                <input
                  type="checkbox"
                  ${goal.completed ? 'checked' : ''}
                  onchange="toggleGoal(${goal.id})"
                  class="w-5 h-5 text-indigo-600 bg-white/20 border-white/30 rounded focus:ring-indigo-500 focus:ring-2 mr-3"
                />
                <div class="flex-1">
                  <h4 class="text-white font-semibold ${goal.completed ? 'line-through' : ''}">${goal.title}</h4>
                  <div class="flex items-center gap-4 mt-1">
                    <span class="px-2 py-1 bg-gradient-to-r ${categoryColors[goal.category]} text-white text-xs rounded-full">
                      ${goal.category}
                    </span>
                    <span class="text-white/60 text-sm">üìÖ ${deadlineText}</span>
                    ${isOverdue ? '<span class="text-red-400 text-sm">‚ö†Ô∏è Overdue</span>' : ''}
                  </div>
                </div>
              </div>
              <button
                onclick="deleteGoal(${goal.id})"
                class="text-white/60 hover:text-red-400 transition-colors ml-3"
              >
                üóëÔ∏è
              </button>
            </div>
          </div>
        `;
      }).join('');
    }
    
    // Initialize goals when goals section is shown
    const originalShowSection = showSection;
    showSection = function(sectionId) {
      originalShowSection(sectionId);
      if (sectionId === 'goals') {
        updateStats();
        renderGoals();
      }
    };
  });
</script>