---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.svelte';
---

<Layout title="Personalize - Deciso">
  <Header showAuthButtons={false} client:load />
  
  <main class="min-h-screen py-8 px-4">
    <div class="max-w-2xl mx-auto">
      <div class="bg-white/10 backdrop-blur-md p-8 rounded-xl border border-white/20">
        <div class="text-center mb-8">
          <h2 class="text-3xl font-bold text-white">Let's Personalize Your Experience</h2>
          <p class="text-white/70 mt-2">Tell us about yourself to get tailored recommendations</p>
        </div>
        
        <form id="personalizeForm" class="space-y-6">
          <!-- Personal Information -->
          <div class="space-y-4">
            <h3 class="text-xl font-semibold text-white">Personal Information</h3>
            
            <div class="grid md:grid-cols-2 gap-4">
              <div>
                <label for="age" class="block text-sm font-medium text-white mb-2">Age</label>
                <input
                  type="number"
                  id="age"
                  name="age"
                  min="18"
                  max="100"
                  class="w-full px-3 py-2 bg-white/10 border border-white/20 rounded-md text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-white/50"
                  placeholder="25"
                />
              </div>
              
              <div>
                <label for="occupation" class="block text-sm font-medium text-white mb-2">Occupation</label>
                <input
                  type="text"
                  id="occupation"
                  name="occupation"
                  class="w-full px-3 py-2 bg-white/10 border border-white/20 rounded-md text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-white/50"
                  placeholder="Software Developer"
                />
              </div>
            </div>
            
            <div>
              <label for="location" class="block text-sm font-medium text-white mb-2">Location</label>
              <input
                type="text"
                id="location"
                name="location"
                class="w-full px-3 py-2 bg-white/10 border border-white/20 rounded-md text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-white/50"
                placeholder="New York, NY"
              />
            </div>
          </div>
          
          <!-- Financial Information -->
          <div class="space-y-4">
            <h3 class="text-xl font-semibold text-white">Financial Goals</h3>
            
            <div class="grid md:grid-cols-2 gap-4">
              <div>
                <label for="monthlyIncome" class="block text-sm font-medium text-white mb-2">Monthly Income</label>
                <input
                  type="number"
                  id="monthlyIncome"
                  name="monthlyIncome"
                  class="w-full px-3 py-2 bg-white/10 border border-white/20 rounded-md text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-white/50"
                  placeholder="5000"
                />
              </div>
              
              <div>
                <label for="monthlyBudget" class="block text-sm font-medium text-white mb-2">Monthly Budget</label>
                <input
                  type="number"
                  id="monthlyBudget"
                  name="monthlyBudget"
                  class="w-full px-3 py-2 bg-white/10 border border-white/20 rounded-md text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-white/50"
                  placeholder="4000"
                />
              </div>
            </div>
            
            <div>
              <label for="financialGoals" class="block text-sm font-medium text-white mb-2">Financial Goals</label>
              <textarea
                id="financialGoals"
                name="financialGoals"
                rows="3"
                class="w-full px-3 py-2 bg-white/10 border border-white/20 rounded-md text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-white/50"
                placeholder="Save for a house, pay off student loans, build emergency fund..."
              ></textarea>
            </div>
          </div>
          
          <!-- Style Preferences -->
          <div class="space-y-4">
            <h3 class="text-xl font-semibold text-white">Style Preferences</h3>
            
            <div>
              <label for="styleType" class="block text-sm font-medium text-white mb-2">Preferred Style</label>
              <select
                id="styleType"
                name="styleType"
                class="w-full px-3 py-2 bg-white/10 border border-white/20 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-white/50"
              >
                <option value="">Select your style</option>
                <option value="casual">Casual</option>
                <option value="business">Business</option>
                <option value="trendy">Trendy</option>
                <option value="classic">Classic</option>
                <option value="bohemian">Bohemian</option>
              </select>
            </div>
            
            <div class="grid md:grid-cols-2 gap-4">
              <div>
                <label for="favoriteColors" class="block text-sm font-medium text-white mb-2">Favorite Colors</label>
                <input
                  type="text"
                  id="favoriteColors"
                  name="favoriteColors"
                  class="w-full px-3 py-2 bg-white/10 border border-white/20 rounded-md text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-white/50"
                  placeholder="Blue, Black, White"
                />
              </div>
              
              <div>
                <label for="bodyType" class="block text-sm font-medium text-white mb-2">Body Type</label>
                <select
                  id="bodyType"
                  name="bodyType"
                  class="w-full px-3 py-2 bg-white/10 border border-white/20 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-white/50"
                >
                  <option value="">Select body type</option>
                  <option value="slim">Slim</option>
                  <option value="athletic">Athletic</option>
                  <option value="curvy">Curvy</option>
                  <option value="plus-size">Plus Size</option>
                </select>
              </div>
            </div>
          </div>
          
          <!-- Lifestyle -->
          <div class="space-y-4">
            <h3 class="text-xl font-semibold text-white">Lifestyle</h3>
            
            <div>
              <label class="block text-sm font-medium text-white mb-2">Interests (Select all that apply)</label>
              <div class="grid grid-cols-2 gap-2">
                <label class="flex items-center text-white/70">
                  <input type="checkbox" name="interests" value="fitness" class="mr-2 rounded">
                  Fitness
                </label>
                <label class="flex items-center text-white/70">
                  <input type="checkbox" name="interests" value="travel" class="mr-2 rounded">
                  Travel
                </label>
                <label class="flex items-center text-white/70">
                  <input type="checkbox" name="interests" value="technology" class="mr-2 rounded">
                  Technology
                </label>
                <label class="flex items-center text-white/70">
                  <input type="checkbox" name="interests" value="cooking" class="mr-2 rounded">
                  Cooking
                </label>
                <label class="flex items-center text-white/70">
                  <input type="checkbox" name="interests" value="reading" class="mr-2 rounded">
                  Reading
                </label>
                <label class="flex items-center text-white/70">
                  <input type="checkbox" name="interests" value="music" class="mr-2 rounded">
                  Music
                </label>
              </div>
            </div>
          </div>
          
          <button
            type="submit"
            id="submitBtn"
            class="w-full bg-white text-indigo-600 py-3 px-4 rounded-md font-semibold hover:bg-gray-100 transition-colors"
          >
            Complete Setup & Go to Dashboard
          </button>
        </form>
      </div>
    </div>
  </main>
</Layout>

<script>
  document.getElementById('personalizeForm')?.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const submitBtn = document.getElementById('submitBtn') as HTMLButtonElement | null;
    if (submitBtn) {
      submitBtn.textContent = 'Saving...';
      submitBtn.disabled = true;
    }
    
    // Collect form data
    const formData = {
      age: parseInt((document.getElementById('age') as HTMLInputElement)?.value) || null,
      occupation: (document.getElementById('occupation') as HTMLInputElement)?.value || null,
      location: (document.getElementById('location') as HTMLInputElement)?.value || null,
      monthlyIncome: parseFloat((document.getElementById('monthlyIncome') as HTMLInputElement)?.value) || null,
      monthlyBudget: parseFloat((document.getElementById('monthlyBudget') as HTMLInputElement)?.value) || null,
      financialGoals: (document.getElementById('financialGoals') as HTMLTextAreaElement)?.value || null,
      styleType: (document.getElementById('styleType') as HTMLSelectElement)?.value || null,
      favoriteColors: (document.getElementById('favoriteColors') as HTMLInputElement)?.value || null,
      bodyType: (document.getElementById('bodyType') as HTMLSelectElement)?.value || null,
      interests: Array.from(document.querySelectorAll<HTMLInputElement>('input[name="interests"]:checked')).map(cb => cb.value)
    };
    
    try {
      const response = await fetch('http://localhost:5000/api/profile', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        credentials: 'include',
        body: JSON.stringify(formData)
      });
      
      if (response.ok) {
        // Also store in localStorage for immediate access
        localStorage.setItem('userProfile', JSON.stringify(formData));
        window.location.href = '/dashboard#financial';
      } else {
        const error = await response.json();
        alert('Error saving profile: ' + (error.error || 'Unknown error'));
        if (submitBtn) {
          submitBtn.textContent = 'Complete Setup & Go to Dashboard';
          submitBtn.disabled = false;
        }
      }
    } catch (error) {
      console.error('Error:', error);
      // Still save to localStorage and redirect even if backend fails
      localStorage.setItem('userProfile', JSON.stringify(formData));
      window.location.href = '/dashboard#financial';
    }
  });
</script>